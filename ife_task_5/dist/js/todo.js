define(["util","store","template"],function(t,e,n){"use strict";function i(t,e,n){this.addTime=Date.now(),this.cid="cid_"+this.addTime,this.pid=t||null,this.level=e||0,this.title=n||"",this.childCatList=[],this.childTodoList=[]}function a(t,e,n,i){this.addTime=Date.now(),this.tid="tid_"+this.addTime,this.cid=t,this.level=0,this.title=e,this.content=n,this.isFinish=!1,this.expireTime=i}var d=function(){var a=null,d=e.data("topCatId");if(!d){var o=new i(null,0,"顶级分类");o.addTime=o.addTime-1,o.cid="cid_"+o.addTime,d=o.cid,e.data("topCatId",d);var r=new i(d,o.level+1,"默认分类");e.data(r.cid,r),o.childCatList.push(r.cid),e.data(d,o),o=null,r=null}var l=function(t,n){var i=e.data(t);if(i){n(i);for(var a=i.childCatList,d=0,o=a.length;d<o;d+=1)l(a[d],n)}},c=function(t){var e=[];return l(t,function(t){e=e.concat(t.childCatList)}),e},s=function(t){var e=[];return l(t,function(t){e=e.concat(t.childTodoList)}),e},u=function(){return s(d)},f=function(t){return t.paddingLeft=0+20*t.level,n("category-item-tpl",t)},h=function(t){if(!t)return"";for(var n=t.childCatList,i=t.pid?'<ul class="hidden">':"<ul>",a=0,d=n.length;a<d;a+=1){var o=e.data(n[a]);o&&(i+="<li>",i+=f(o),o.childCatList.length>0&&(i+=h(o)),i+="</li>")}return i+="</ul>"},v=function(e,n){var i="<li>"+f(n)+"</li>",a=t.$("ul",e);if(a)a.innerHTML+=i;else{var d=document.createElement("ul");d.innerHTML=i,e.appendChild(d)}},m=function(t,n){var a=e.data(t),d=new i(t,a.level+1,n);return e.data(d.cid,d),a.childCatList.push(d.cid),e.data(a.cid,a),d},g=function(t){e.remove(t)},p=function(t){var n=e.data(t),i=e.data(n.pid),a=i.childCatList;a.splice(a.indexOf(t),1),e.data(i.cid,i);var d=c(t);d.push(t);for(var o=0,r=d.length;o<r;o+=1)g(d[o])},C=function(t){p(t),w()},I=function(n,i){var a=t.$(".td-count",t.$("#"+n));a&&(a.innerHTML="("+(t.isNumber(i)?i:e.data(n).childTodoList.length)+")")},w=function(){I("#show-all-todo",u().length)},T=function(t,e){I(t,e),w()},$=function(t,n){var i=e.data(t);i.childTodoList.push(n),e.data(t,i),T(t,i.childTodoList.length)},L=function(t,n){var i=e.data(t),a=i.childTodoList;a.splice(a.indexOf(n),1),e.data(t,i),T(t,i.childTodoList.length)},b=function(t){return e.data(t)},k=function(t,n){for(var i=e.data(t).childCatList,a=0,d=i.length;a<d;a+=1)if(e.data(i[a]).title===n)return!0;return!1},N=function(t){var n=e.data(t);if(!n)return"未命名分类";for(var i="",a=n.childCatList,d=0,o=a.length;d<o;d+=1)if(i="未命名分类"+(d+1),!k(t,i))return i;return i="未命名分类"+(d+1)},y=function(){return d},x=function(){return a};return{init:function(n){a=n||a;var i=t.$("#"+a);i&&(i.innerHTML=h(e.data(d))),w()},addItem:m,getItem:b,addItemTemplate:v,addChildTodo:$,removeChildTodo:L,removeCategory:C,hasSameName:k,getValidName:N,getTodoListIds:s,getAllTodoList:u,getTopCatId:y,getWrapperId:x}}(),o=function(){var i=null,d=function(e,n){for(var i=[],a=0;a<e.length;a+=1){var d=l(e[a]);d&&(t.isBool(n)&&n!==d.isFinish||i.push(d))}return i},o=function(t){for(var e={},n=0,i=t.length;n<i;n+=1){var a=j(t[n].expireTime);e[a]||(e[a]=[]),e[a].push(t[n])}return e},r=function(t,e){var i=d(t,e);if(!i||i.length<=0)return"";i=o(i);var a=Object.keys(i);a.sort(function(t,e){return t>e?-1:t<e?1:0});for(var r="<ul>",l=null,c=0,s=a.length;c<s;c+=1)l={time:a[c],list:i[a[c]]},r+=n("todo-group-tpl",l);return r+="</ul>"},l=function(t){return e.data(t)},c=function(t){e.data(t.tid,t)},s=function(t,e,n,i){var d=new a(t,e,n,i);return c(d),d},u=function(t){e.remove(t)},f=function(t){t.forEach(function(t){u(t)})},h=function(t){var e=l(t);e.isFinish=!e.isFinish,c(e)},v=function(){return i};return{init:function(t){i=t||i},reload:function(e,n){var a=t.$("#"+i);a&&(a.innerHTML=r(e,n))},getItem:l,setItem:c,addItem:s,getWrapperId:v,deleteItem:u,deleteItemList:f,toggleMark:h}}(),r=function(){var e=null;n.helper("dateFormat",function(t){return j(t)});var i=function(t){return t=t||{title:"",expireTime:"",content:""},n("show-item-tpl",t)},a=function(t){return t=t||{title:"未命名任务",expireTime:Date.now(),content:""},n("edit-item-tpl",t)},d=function(n){var a=t.$("#"+e);a.innerHTML=i(n);var d=a.parentNode;B(t.$("#save-btns"),d),S(t.$("#edit-btns",d))},o=function(n){var i=t.$("#"+e);i.innerHTML=a(n);var d=i.parentNode;S(t.$("#save-btns"),d),B(t.$("#edit-btns",d))};return{init:function(t){e=t||e},showItem:d,editItem:o}}(),l={prompt:function(t,e){return window.prompt(t,e)},alert:function(t){return window.alert(t)},confirm:function(t){return window.confirm(t)},showInfo:function(t){window.alert(t)},need:function(t,e,n){switch(t){case"add-category":return e=e||"请输入分类名称",this.prompt(e,n||"");case"delete-category":case"delete-todo":return e=e||"你确定删除选中项和相关数据吗？",this.confirm(e)}}},c=d,s=o,u=r,f=null,h=null,v=null,m=null,g=["#menu","#list","#detail"],p=0,C=function(e){e=t.getEvent(e),t.cancelBubble(e);var n=t.getEventTarget(e),i=n.dataset&&n.dataset.action||n.getAttribute("data-action"),a=!0;t.hasClass(n.parentNode,"item")&&(n=n.parentNode),t.hasClass(n,"item")||(a=!1);var d=null,o=null,r=null;switch(i){case"add-category":var v=f.id;if("show-all-todo"===v)return void l.showInfo("请先选中一个父分类！");"show-all-cat"===v&&(v=c.getTopCatId());var g=c.getValidName(v);d="请输入在 <"+c.getItem(v).title+"> 下创建的子分类名称：";var p=!0;do{if(g=l.need(i,d,g),null===(g=g&&g.replace(/[\s]+/," "))){p=!1;break}""===g?(p=!1,d="注意：名称不能为空！"):/[^\w\u4E00-\u9FA5]+/g.test(g)?(p=!1,d="注意：名称只能包含汉字、字母、数字、下划线！"):c.hasSameName(v,g)&&(p=!1,d="注意：该分类下已使用过相同名称！")}while(!p);if(p){var C=c.addItem(v,g);c.addItemTemplate(f.parentNode,C),M(f)}break;case"delete-category":if(o=n.id,d="你确定删除 <"+c.getItem(o).title+"> 以及该分类下的子分类和任务吗？",!l.need(i,d))return;var I=c.getTodoListIds(o);s.deleteItemList(I),c.removeCategory(o);var $=n.parentNode,L=$.parentNode;L.removeChild($),o===f.id&&E(t.$("li",L.parentNode)||L.parentNode);break;case"add-todo":if(o=f.id,o.indexOf("cid_")<0)return void l.showInfo("请选中分类列表中的一个分类！");m=i,u.editItem(),T();break;case"edit-todo":h?(m=i,u.editItem(s.getItem(h.id))):l.showInfo("请先选择任务列表中的一个任务！");break;case"save-edit":if(!m)return;var b=t.trim(t.$("#todo-title").value),k=t.$("#todo-expire").value,F=t.$("#todo-content").value;if(!b.length||b.length>30)return void l.showInfo("任务名称不能为空，也不能超过30字！");if(!k.length)return void l.showInfo("过期时间不能为空！");if(!F.length||F.length>800)return void l.showInfo("任务内容不能为空，也不能超过800字！");b=t.htmlEncode(b),F=t.htmlEncode(F),k=new Date(k).getTime(),"add-todo"===m?(r=s.addItem(f.id,b,F,k),c.addChildTodo(r.cid,r.tid)):"edit-todo"===m&&(r=s.getItem(h.id),r.title=b,r.expireTime=k,r.content=F,s.setItem(r)),W(),D(t.$("#"+r.tid)),m=null;break;case"cancel-edit":"add-todo"===m&&w(),A(),m=null;break;case"delete-todo":if(!l.need(i,"你确定删除该任务吗？"))return;r=s.getItem(n.id),s.deleteItem(r.tid),c.removeChildTodo(r.cid,r.tid);var O=n.parentNode;O.parentNode.removeChild(O),h.id===n.id&&H();break;case"mark-todo":var _=n.id;s.toggleMark(_);var j=h.id;W(),D(t.$("#"+j));break;case"switch-statu":W(n);break;case"act-back":w();break;default:if(!a)return;t.hasClass(n,"item-cat")?(x(n),T()):t.hasClass(n,"item-todo")?(D(n),T()):"show-all-cat"===n.id?y(n):"show-all-todo"===n.id&&(N(n),T())}},I=function(){t.addEvent(document.body,"click",C),t.addEvent(document.body,"touchstart",function(){}),t.addEvent(document.body,"touchend",function(){})},w=function(){t.addClass(t.$(g[p]),"page-next"),t.removeClass(t.$(g[p]),"page-active"),p=p-1<0?0:p-1,t.addClass(t.$(g[p]),"page-active"),t.removeClass(t.$(g[p]),"page-prev"),$(p)},T=function(){t.addClass(t.$(g[p]),"page-prev"),t.removeClass(t.$(g[p]),"page-active"),p=p+1>=g.length?p:p+1,t.addClass(t.$(g[p]),"page-active"),t.removeClass(t.$(g[p]),"page-next"),$(p)},$=function(e){e>0?S(t.$("#page-back")):B(t.$("#page-back"))},L=function(e,n,i){t.removeClass(e,i),t.addClass(n,i)},b=function(t,e){L(t,e,"selected")},k=function(t){b(f,t),f=t||f,_()},N=function(t){k(t)},y=function(t){k(t)},x=function(e){var n=t.$("ul",e.parentNode);n&&t.toggleClass(n,"hidden"),t.hasClass(e,"icon-folder")&&t.toggleClass(e,"folder-opened"),k(e)},E=function(e){e=e||t.$("#"+c.getWrapperId());var n=t.$(".item-cat",e)||t.$(".item",e);k(n)},M=function(e){if(t.hasClass(e,"item-cat")){var n=t.$("ul",e.parentNode);n&&(t.removeClass(n,"hidden"),t.addClass(e,"folder-opened"))}},F=function(t){b(h,t),h=t,A()},H=function(e){e=e||t.$("#"+s.getWrapperId());var n=t.$(".item-todo",e)||t.$(".item",e);F(n)},D=function(t){t?F(t):H()},A=function(){h?u.showItem(s.getItem(h.id)):u.showItem()},O=function(t){b(v,t),v=t||v,_()},W=function(e){e=e||v||t.$("#statu-all"),O(e)},_=function(){if(f){var t=[];switch(f.id){case"show-all-cat":break;case"show-all-todo":t=c.getAllTodoList();break;default:t=c.getItem(f.id).childTodoList}var e=null;switch(v.id){case"statu-not":e=!1;break;case"statu-done":e=!0}s.reload(t,e),H()}},j=function(t,e){if(!t)return"";e=e||"-";var n=new Date(t),i=n.getFullYear(),a=n.getMonth()+1,d=n.getDate();return[i,a<10?"0"+a:a,d<10?"0"+d:d].join(e)},B=function(e){t.addClass(e,"hidden")},S=function(e){t.removeClass(e,"hidden")};return{init:function(){c.init("category-list"),s.init("todo-list"),u.init("detail-wrap"),W(t.$("#statu-all")),E(t.$("#category-list")),I()}}});
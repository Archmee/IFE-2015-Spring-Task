define(["util","store","template"],function(t,e,n){"use strict";function i(t,e,n){this.addTime=Date.now(),this.cid="cid_"+this.addTime,this.pid=t||null,this.level=e||0,this.title=n||"",this.childCatList=[],this.childTodoList=[]}function a(t,e,n,i){this.addTime=Date.now(),this.tid="tid_"+this.addTime,this.cid=t,this.level=0,this.title=e,this.content=n,this.isFinish=!1,this.expireTime=i}function o(e){e=t.getEvent(e),t.cancelBubble(e);var n=t.getEventTarget(e),i=n.dataset&&n.dataset.action||n.getAttribute("data-action"),a=!0;t.hasClass(n.parentNode,"item")&&(n=n.parentNode),t.hasClass(n,"item")||(a=!1);var o=null,d=null,c=null;switch(i){case"add-category":var s=W.id;if("show-all-todo"===s)return void H.showInfo("请先选中一个父分类！");"show-all-cat"===s&&(s=D.getTopCatId());var f=D.getValidName(s);o="请输入在 <"+D.getItem(s).title+"> 下创建的子分类名称：";var h=!0;do{if(f=H.need(i,o,f),null===(f=f&&f.replace(/[\s]+/," "))){h=!1;break}""===f?(h=!1,o="注意：名称不能为空！"):/[^\w\u4E00-\u9FA5]+/g.test(f)?(h=!1,o="注意：名称只能包含汉字、字母、数字、下划线！"):D.hasSameName(s,f)&&(h=!1,o="注意：该分类下已使用过相同名称！")}while(!h);if(h){var I=D.addItem(s,f);D.addItemTemplate(W.parentNode,I),C(W)}break;case"delete-category":if(d=n.id,o="你确定删除 <"+D.getItem(d).title+"> 以及该分类下的子分类和任务吗？",!H.need(i,o))return;var T=D.getTodoListIds(d);A.deleteItemList(T),D.removeCategory(d);var L=n.parentNode,N=L.parentNode;N.removeChild(L),d===W.id&&p(t.$("li",N.parentNode)||N.parentNode);break;case"add-todo":if(d=W.id,d.indexOf("cid_")<0)return void H.showInfo("请选中分类列表中的一个分类！");B=i,O.editItem(),l();break;case"edit-todo":_?(B=i,O.editItem(A.getItem(_.id))):H.showInfo("请先选择任务列表中的一个任务！");break;case"save-edit":if(!B)return;var y=t.trim(t.$("#todo-title").value),x=t.$("#todo-expire").value,M=t.$("#todo-content").value;if(!y.length||y.length>30)return void H.showInfo("任务名称不能为空，也不能超过30字！");if(!x.length)return void H.showInfo("过期时间不能为空！");if(!M.length)return void H.showInfo("任务内容不能为空！");y=u(y),M=u(M),x=new Date(x).getTime(),"add-todo"===B?(c=A.addItem(W.id,y,M,x),D.addChildTodo(c.cid,c.tid)):"edit-todo"===B&&(c=A.getItem(_.id),c.title=y,c.expireTime=x,c.content=M,A.setItem(c)),b(j),w(t.$("#"+c.tid)),B=null;break;case"cancel-edit":"add-todo"===B&&r(),$(),B=null;break;case"delete-todo":if(!H.need(i,"你确定删除该任务吗？"))return;c=A.getItem(n.id),A.deleteItem(c.tid),D.removeChildTodo(c.cid,c.tid);var E=n.parentNode;E.parentNode.removeChild(E);break;case"mark-todo":A.toggleMark(n.id),k();break;case"switch-statu":b(n);break;case"act-back":r();break;default:if(!a)return;t.hasClass(n,"item-cat")?(g(n),l()):t.hasClass(n,"item-todo")?(w(n),l()):"show-all-cat"===n.id?m(n):"show-all-todo"===n.id&&(v(n),l())}}function d(){t.addEvent(document.body,"click",o),t.addEvent(document.body,"touchstart",function(){}),t.addEvent(document.body,"touchend",function(){})}function r(){t.addClass(t.$(S[V]),"page-next"),t.removeClass(t.$(S[V]),"page-active"),V=V-1<0?0:V-1,t.addClass(t.$(S[V]),"page-active"),t.removeClass(t.$(S[V]),"page-prev"),c(V)}function l(){t.addClass(t.$(S[V]),"page-prev"),t.removeClass(t.$(S[V]),"page-active"),V=V+1>=S.length?V:V+1,t.addClass(t.$(S[V]),"page-active"),t.removeClass(t.$(S[V]),"page-next"),c(V)}function c(e){e>0?x(t.$("#page-back")):y(t.$("#page-back"))}function u(t){return t.replace(/<\/?([^>]+)>/g,"")}function s(e,n,i){t.removeClass(e,i),t.addClass(n,i)}function f(t,e){s(t,e,"selected")}function h(t){f(W,t),W=t||W,k()}function v(t){h(t)}function m(t){h(t)}function g(e){var n=t.$("ul",e.parentNode);n&&t.toggleClass(n,"hidden"),t.hasClass(e,"icon-folder")&&t.toggleClass(e,"folder-opened"),h(e)}function p(e){e=e||t.$("#"+D.getWrapperId()),h(t.$(".item-cat",e)||t.$(".item",e))}function C(e){if(t.hasClass(e,"item-cat")){var n=t.$("ul",e.parentNode);n&&(t.removeClass(n,"hidden"),t.addClass(e,"folder-opened"))}}function I(t){f(_,t),_=t,$()}function w(t){I(t)}function T(e){e=e||t.$("#"+A.getWrapperId()),I(t.$(".item-todo",e)||t.$(".item",e))}function $(){_?O.showItem(A.getItem(_.id)):O.showItem()}function L(t){f(j,t),j=t||j,k()}function b(e){e=e||t.$("#statu-all"),L(e)}function k(){if(W){var t=[];switch(W.id){case"show-all-cat":break;case"show-all-todo":t=D.getAllTodoList();break;default:t=D.getItem(W.id).childTodoList}var e=null;switch(j.id){case"statu-not":e=!1;break;case"statu-done":e=!0}A.reload(t,e),T()}}function N(t,e){if(!t)return"";e=e||"-";var n=new Date(t),i=n.getFullYear(),a=n.getMonth()+1,o=n.getDate();return[i,a<10?"0"+a:a,o<10?"0"+o:o].join(e)}function y(e){t.addClass(e,"hidden")}function x(e){t.removeClass(e,"hidden")}var M=function(){var a=null,o=e.data("topCatId");if(!o){var d=new i(null,0,"顶级分类");d.addTime=d.addTime-1,d.cid="cid_"+d.addTime,o=d.cid,e.data("topCatId",o);var r=new i(o,d.level+1,"默认分类");e.data(r.cid,r),d.childCatList.push(r.cid),e.data(o,d),d=null,r=null}var l=function(t,n){var i=e.data(t);if(i){n(i);for(var a=i.childCatList,o=0,d=a.length;o<d;o+=1)l(a[o],n)}},c=function(t){var e=[];return l(t,function(t){e=e.concat(t.childCatList)}),e},u=function(t){var e=[];return l(t,function(t){e=e.concat(t.childTodoList)}),e},s=function(){return u(o)},f=function(t){return t.paddingLeft=0+20*t.level,n("category-item-tpl",t)},h=function(t){if(!t)return"";for(var n=t.childCatList,i=t.pid?'<ul class="hidden">':"<ul>",a=0,o=n.length;a<o;a+=1){var d=e.data(n[a]);d&&(i+="<li>",i+=f(d),d.childCatList.length>0&&(i+=h(d)),i+="</li>")}return i+="</ul>"},v=function(e,n){var i="<li>"+f(n)+"</li>",a=t.$("ul",e);if(a)a.innerHTML+=i;else{var o=document.createElement("ul");o.innerHTML=i,e.appendChild(o)}},m=function(t,n){var a=e.data(t),o=new i(t,a.level+1,n);return e.data(o.cid,o),a.childCatList.push(o.cid),e.data(a.cid,a),o},g=function(t){e.remove(t)},p=function(t){var n=e.data(t),i=e.data(n.pid),a=i.childCatList;a.splice(a.indexOf(t),1),e.data(i.cid,i);var o=c(t);o.push(t);for(var d=0,r=o.length;d<r;d+=1)g(o[d])},C=function(t){p(t),w()},I=function(n,i){var a=t.$(".td-count",t.$("#"+n));a&&(a.innerHTML="("+(t.isNumber(i)?i:e.data(n).childTodoList.length)+")")},w=function(){I("#show-all-todo",s().length)},T=function(t,e){I(t,e),w()},$=function(t,n){var i=e.data(t);i.childTodoList.push(n),e.data(t,i),T(t,i.childTodoList.length)},L=function(t,n){var i=e.data(t),a=i.childTodoList;a.splice(a.indexOf(n),1),e.data(t,i),T(t,i.childTodoList.length)},b=function(t){return e.data(t)},k=function(t,n){for(var i=e.data(t).childCatList,a=0,o=i.length;a<o;a+=1)if(e.data(i[a]).title===n)return!0;return!1},N=function(t){var n=e.data(t);if(!n)return"未命名分类";for(var i="",a=n.childCatList,o=0,d=a.length;o<d;o+=1)if(i="未命名分类"+(o+1),!k(t,i))return i;return i="未命名分类"+(o+1)},y=function(){return o},x=function(){return a};return{init:function(n){a=n||a;var i=t.$("#"+a);i&&(i.innerHTML=h(e.data(o))),w()},addItem:m,getItem:b,addItemTemplate:v,addChildTodo:$,removeChildTodo:L,removeCategory:C,hasSameName:k,getValidName:N,getTodoListIds:u,getAllTodoList:s,getTopCatId:y,getWrapperId:x}}(),E=function(){function i(e,n){for(var i=[],a=0;a<e.length;a+=1){var o=r(e[a]);o&&(t.isBool(n)&&n!==o.isFinish||i.push(o))}return i}function o(t){for(var e={},n=0,i=t.length;n<i;n+=1){var a=N(t[n].expireTime);e[a]||(e[a]=[]),e[a].push(t[n])}return e}function d(t,e){var a=i(t,e);if(!a||a.length<=0)return"";a=o(a);var d=Object.keys(a);d.sort(function(t,e){return t>e?-1:t<e?1:0});for(var r="<ul>",l=null,c=0,u=d.length;c<u;c+=1)l={time:d[c],list:a[d[c]]},r+=n("todo-group-tpl",l);return r+="</ul>"}function r(t){return e.data(t)}function l(t){e.data(t.tid,t)}function c(t,e,n,i){var o=new a(t,e,n,i);return l(o),o}function u(t){e.remove(t)}function s(t){t.forEach(function(t){u(t)})}function f(t){var e=r(t);e.isFinish=!e.isFinish,l(e)}function h(){return v}var v=null;return{init:function(t){v=t||v},reload:function(e,n){var i=t.$("#"+v);i&&(i.innerHTML=d(e,n))},getItem:r,setItem:l,addItem:c,getWrapperId:h,deleteItem:u,deleteItemList:s,toggleMark:f}}(),F=function(){var e=null;n.helper("dateFormat",function(t){return N(t)});var i=function(t){return t=t||{title:"",expireTime:"",content:""},n("show-item-tpl",t)},a=function(t){return t=t||{title:"未命名任务",expireTime:Date.now(),content:""},n("edit-item-tpl",t)},o=function(n){var a=t.$("#"+e);a.innerHTML=i(n);var o=a.parentNode;y(t.$("#save-btns")),x(t.$("#edit-btns",o))},d=function(n){var i=t.$("#"+e);i.innerHTML=a(n);var o=i.parentNode;x(t.$("#save-btns")),y(t.$("#edit-btns",o))};return{init:function(t){e=t||e},showItem:o,editItem:d}}(),H={prompt:function(t,e){return window.prompt(t,e)},alert:function(t){return window.alert(t)},confirm:function(t){return window.confirm(t)},showInfo:function(t){window.alert(t)},need:function(t,e,n){switch(t){case"add-category":return e=e||"请输入分类名称",this.prompt(e,n||"");case"delete-category":case"delete-todo":return e=e||"你确定删除选中项和相关数据吗？",this.confirm(e)}}},D=M,A=E,O=F,W=null,_=null,j=null,B=null,S=["#menu","#list","#detail"],V=0;return{init:function(){D.init("category-list"),A.init("todo-list"),O.init("detail-wrap"),b(t.$("#statu-all")),p(t.$("#category-list")),d()}}});